<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <meta name="description" content="">
        <meta name="author" content="">
        <link rel="apple-touch-icon" sizes="180x180" href="../dist/images/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="../dist/images/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="../dist/images/favicon-16x16.png">
        <link rel="manifest" href="../dist/images/manifest.json">
        <link rel="mask-icon" href="../dist/images/safari-pinned-tab.svg" color="#5bbad5">
        <link rel="shortcut icon" href="../dist/images/favicon.ico">
        <meta name="msapplication-config" content="../dist/images/browserconfig.xml">
        <meta name="theme-color" content="#ffffff">

        <title>Filtered page</title>

        <!-- Bootstrap core CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">

        <!-- Custom (table) style -->
        <link rel="stylesheet" href="../dist/css/custom.css"> 
        
        
    </head>

    <body>
        <!--==== Navbar ====-->
        <nav class="navbar navbar-toggleable-md navbar-light bg-faded">
          <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <a class="navbar-brand" href="../">Project Brew</a>

          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
              <li class="nav-item">
                <a class="nav-link" href="../">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="topTen.html">Top 10</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="allBeers.html">All Beers</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="onSale.html">On Sale</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="kegsOnly.html">Kegs</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="#">Search</a>
              </li>
            </ul>
          </div>
        </nav>

        <!--==== Main page ====-->
        <div class="container">
            <div class="row">
                <div class="col-lg-10 offset-lg-1">
                    <h1 class="text-center display-4">Search beers</h1><br>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-10 offset-lg-1">
                    <h3 class="text-center display-4 text-muted" style="font-size: 200%">What kind of beer are you looking for?</h3><br>
                </div>
            </div>
            <div class="row">
                <div class="col text-center">
                    <h4 class="text-center">Container</h4>
                    <div class="row">
                        <div class="col-sm-3">
                            <p class="lead text-left">Type</p>
                        </div>
                        <div class="col">
                            <div class="btn-group" role="group" data-toggle="buttons">
                                <label id="tp-bot" class="btn btn-secondary active">
                                    <input type="checkbox" checked autocomplete="off">Bottle</label>
                                <label id="tp-can" class="btn btn-secondary active">
                                    <input type="checkbox" checked autocomplete="off">Can</label>
                                <label id="tp-keg" class="btn btn-secondary active">
                                    <input type="checkbox" checked autocomplete="off">Keg</label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-3 text-left">
                            <p class="lead">Quantity</p>
                        </div>
                        <div class="col">
                            <div class="input-group">
                              <input id="qnt-min" type="text" class="form-control" placeholder="Min" aria-label="Min">
                            </div>
                        </div>
                        <div class="col">
                            <div class="input-group">
                              <input id="qnt-max" type="text" class="form-control" placeholder="Max" aria-label="Min">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-2">
                            <p class="lead">Size</p>
                        </div>
                        <div class="col">
                            <div class="input-group">
                              <input id="min-sz" type="text" class="form-control" placeholder="Min" aria-label="Min">
                              <span class="input-group-addon">mL</span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="input-group">
                              <input id="max-sz" type="text" class="form-control" placeholder="Max" aria-label="Min">
                              <span class="input-group-addon">mL</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col text-center">
                    <h4 class="text-center">Keywords</h4>
                    <br><br>
                    <div class="input-group">
                      <input id="keywords" type="text" class="form-control text-center" placeholder="Seperate with a space" aria-label="Min">
                    </div>
                </div>
                <div class="col text-center">
                    <h4 class="text-center">Beer</h4>
                    <div class="row">
                        <!-- Too many types to use this input...
                        <div class="col-sm-2">
                            <p class="lead text-left">Type</p>
                        </div>
                        <div class="col">
                            <div class="btn-group" role="group" data-toggle="buttons">
                                <label class="btn btn-secondary active">
                                    <input id="k-ale" type="checkbox" checked autocomplete="off">Ale</label>
                                <label class="btn btn-secondary active">
                                    <input id="k-lager" type="checkbox" checked autocomplete="off">Lager</label>
                                <label class="btn btn-secondary active">
                                    <input id="k-malt" type="checkbox" checked autocomplete="off">Malt</label>
                                <label class="btn btn-secondary active">
                                    <input id="k-stout" type="checkbox" checked autocomplete="off">Stout</label>
                            </div>
                        </div> -->
                    </div>
                    <div class="row">
                        <div class="col-sm-3">
                            <p class="lead text-left">Alcohol</p>
                        </div>
                        <div class="col">
                            <div class="input-group">
                              <input id="alc-min" type="text" class="form-control" placeholder="Min" aria-label="Min">
                              <span class="input-group-addon">%</span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="input-group">
                              <input id="alc-max" type="text" class="form-control" placeholder="Max" aria-label="Min">
                              <span class="input-group-addon">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-2">
                            <h4 class="lead text-center">Price</h4>
                        </div>
                        <div class="col">
                            <div class="input-group">
                              <input id="prc-min" type="text" class="form-control" placeholder="Min" aria-label="Min">
                              <span class="input-group-addon">$</span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="input-group">
                              <input id="prc-max" type="text" class="form-control" placeholder="Max" aria-label="Min">
                              <span class="input-group-addon">$</span>
                            </div>
                        </div>
                    </div>                    
                </div>
            </div><br>
            
            <!--======== Filter button ========-->
            <div class="row">
                <div class="col-md-6 offset-md-3">
                    <div class="row">
                        <div class="col offset-2 text-center">
                            <button type="button" class="btn btn-success" onclick="filterResults()">Filter now!</button>
                        </div>
                        <div class="col text-center">
                            <button type="button" class="btn btn-danger" onclick="resetResults()">Reset</button>
                        </div>
                        <div class="col-2"></div>
                    </div>
                </div> 
            </div><br>
            
            <!--======== Table ========-->
            <div class="row">
                <div class="col">
                    <table class="table table-hover table-striped table-bordered" id="tableMark">
                        <thread>
                            <tr>
                                <th>Beer</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Size (mL)</th>
                                <th>Alcohol (%)</th>
                                <th>Price</th>
                                <th>Value (mL alc./$)</th>
                                <th>More</th>
                            </tr>
                        </thread>
                    </table>
                </div>
            </div>
            <!-- Modal ================================================================== -->
            <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="s">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="beerTitle"></h4>
                        </div>
                        <!--==== Modal content ====-->
                        <div class="modal-body" id="beerInfo1">
                            <div class="row">
                                <div class="col-md-5 offset-md-1" id="beerInfo"></div>
                            </div>
                            <div class="row">
                                <div class="col-md-5 offset-md-1" id="beerTable"></div>
                                <div class="col-md-5" id="beerPic"></div>
                            </div>
                        </div>    
                        <!--==== Modal footer ====-->
                        <div class="modal-footer">
                            <div class="row justify-content-md-center">
                                <div class="col-md">
                                    <input type="button" class="btn btn-link" id="toPage" value="Go to The Beer Store" onclick="window.open('http://google.ca')">
                                </div>
                                <div class="col-md">
                                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End of Modal ===================================================== -->
        </div><!-- /.container -->


        <!-- Bootstrap core JavaScript ================================================== -->
        <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

        <script>
            function filterResults() {
                var start = Date.now();
                //Container type
                var bot = $('#tp-bot').hasClass('active');
                var can = $('#tp-can').hasClass('active');
                var keg = $('#tp-keg').hasClass('active');
                var type = [], go = false;
                if(!bot && !can && !keg) {go = true;}
                if(bot || go) {type.push('Bottle');}
                if(can || go) {type.push('Can');}
                if(keg || go) {type.push('Keg');}
                
                //Kind of beer
                var ale = $('#k-ale').is(':checked');
                var lager = $('#k-lager').is(':checked');
                var malt = $('#k-malt').is(':checked');
                var stout = $('#k-stout').is(':checked');
                var kind = [];
                if(ale) {kind.push('Ale');}
                if(lager) {kind.push('Lager');}
                if(malt) {kind.push('Malt');}
                if(stout) {kind.push('Stout');}
                
                //More beer info
                var sz_min = $('#min-sz').val();
                var sz_max = $('#max-sz').val();
                var qnt_min = $('#qnt-min').val();
                var qnt_max = $('#qnt-max').val();
                var alc_min = $('#alc-min').val();
                var alc_max = $('#alc-max').val();
                var prc_min = $('#prc-min').val();
                var prc_max = $('#prc-max').val();
                var keys = $('#keywords').val();
                //Misc declarations
                var szMod, qntMod, perMod, prcMod;
                var dftSzMin, dftSzMax, dftQntMin, dftQntMax, dftAlMin, dftAlMax, dftPrMin, dftPrMax;
                
                szMod = false;
                perMod = false;
                prcMod = false;
                qntMod = false;
                dftSzMin = 0;
                dftQntMin = 0;
                dftAlMin = 0;
                dftPrMin = 0;
                dftSzMax = 100000;
                dftQntMax = 100;
                dftAlMax = 100;
                dftPrMax = 10000;
                
                //Size cleaning-----------------------------------
                if(sz_min == "" || isNaN(sz_min) || !isFinite(sz_min)) {
                    sz_min = dftSzMin;
                    szMod = true;
                }
                if(sz_max == "" || isNaN(sz_max) || !isFinite(sz_max)) {
                    sz_max = dftSzMax;
                    szMod = true;
                }
                sz_min = parseFloat(sz_min)
                sz_max = parseFloat(sz_max)
                if(sz_max < sz_min) {
                    sz_max = sz_min;
                    szMod = true;
                }
                
                //Quantity cleaning-----------------------------------
                if(qnt_min == "" || isNaN(qnt_min) || !isFinite(qnt_min)) {
                    qnt_min = dftQntMin;
                    qntMod = true;
                }
                if(qnt_max == "" || isNaN(qnt_max) || !isFinite(qnt_max)) {
                    qnt_max = dftQntMax;
                    qntMod = true;
                }
                qnt_min = parseInt(qnt_min)
                qnt_max = parseInt(qnt_max)
                if(qnt_max < qnt_min) {
                    qnt_max = qnt_min;
                    qntMod = true;
                }
                
                //Percentage cleaning-----------------------------
                if(alc_min == "" || isNaN(alc_min) || !isFinite(alc_min)) {
                    alc_min = dftAlMin;
                    perMod = true;
                }
                alc_min = parseFloat(alc_min);
                if(alc_min < 1 && alc_min != 0) {
                    alc_min *= 100;
                    perMod = true;
                }
                if(alc_max == "" || isNaN(alc_max) || !isFinite(alc_max)) {
                    alc_max = dftAlMax;
                    perMod = true;
                }
                alc_max = parseFloat(alc_max);
                if(alc_max < 1) {
                    alc_max *= 100;
                    perMod = true;
                }
                if(alc_max < alc_min) {
                    alc_max = alc_min;
                    perMod = true;
                }
                
                
                //Price cleaning-----------------------------------
                if(prc_min == "" || isNaN(prc_min) || !isFinite(prc_min)) {
                    prc_min = dftPrMin;
                    prcMod = true;
                }
                if(prc_max == "" || isNaN(prc_max) || !isFinite(prc_max)) {
                    prc_max = dftPrMax;
                    prcMod = true;
                }
                prc_min = parseFloat(prc_min);
                prc_max = parseFloat(prc_max);
                
                if(prc_max < prc_min) {
                    prc_max = prc_min;
                    prcMod = true;
                }
                
                //Write over user input (if necessary)
                if(szMod){
                    if(sz_min != dftSzMin)
                        $('#min-sz').val(sz_min);
                    if(sz_max != dftSzMax)
                        $('#max-sz').val(sz_max);
                }
                if(qntMod){
                    if(qnt_min != dftQntMin)
                        $('#qnt-min').val(qnt_min);
                    if(qnt_max != dftQntMax)
                        $('#qnt-max').val(qnt_max);
                }
                if(perMod) {
                    if(alc_min != dftAlMin)
                        $('#alc-min').val(alc_min);
                    if(alc_max != dftAlMax)
                        $('#alc-max').val(alc_max);
                }
                if(prcMod) {
                    if(prc_min != dftPrMin)
                        $('#prc-min').val(prc_min);
                    if(prc_max != dftPrMax)
                        $('#prc-max').val(prc_max);
                }
                
                var delList = []
                $.each(keys.split(''), function(i, ch) {if(ch.toLowerCase() == ch.toUpperCase() && ch != ' ') {delList.push(i);} });
                delList.reverse();
                keys = keys.split('');
                $.each(delList, function(i, num) {keys.splice(num, 1); });
                keys = (keys.join('')).toLowerCase();
                $('#keywords').val(keys);
                keys = keys.split(' ');
                
                populateTable(type, [qnt_min, qnt_max], [sz_min, sz_max], kind, [alc_min, alc_max], [prc_min, prc_max], keys);
                console.log('Time: ' + String(Date.now() - start))
            }
        </script>
        <script>
            function resetResults() {
                tableContents = '<table class="table table-hover table-striped table-bordered" id="tableMark"><thread><tr><th>Beer</th><th>Type</th><th>Quantity</th><th>Size (mL)</th><th>Alcohol (%)</th><th>Price</th><th>Value (mL alc./$)</th><th>More</th></tr></thread></table>';
                $('#tableMark').replaceWith(tableContents);
                
                if(!$('#tp-bot').is(':checked')) {$('#tp-bot').addClass('active'); };
                if(!$('#tp-can').is(':checked')) {$('#tp-can').addClass('active'); };
                if(!$('#tp-keg').is(':checked')) {$('#tp-keg').addClass('active'); };
                
                $('#keywords').val('');
                
                $('#min-sz').val('');
                $('#max-sz').val('');
                $('#qnt-min').val('');
                $('#qnt-max').val('');
                $('#alc-min').val('');
                $('#alc-max').val('');
                $('#prc-min').val('');
                $('#prc-max').val('');
            }
        </script>
        <script>
            if(jQuery) {
                $(document).ready(function() {
                    var dateTime = new Date(parseInt(window.localStorage.getItem('DT')));
                    if(isNaN(dateTime))  {
                        console.log('No data.');
                        refreshData();
                        return;
                    }
                    var datDay = dateTime.getDate(), datHour = dateTime.getHours();
                    var currDate = (new Date($.now())).getDate();
                    if(currDate == datDay && datHour >= 7) {
                        console.log('Good data.');
                    } else {
                        console.log('Old data.');
                        refreshData();
                    }                  
                })
            }
        </script>
        <script>
            function refreshData() {
                $.get('https://raw.githubusercontent.com/simonsben/MyBeer/master/data/jsonAllData.json', function(newData) {
                    window.localStorage.setItem('Data', newData);
                    window.localStorage.setItem('DT', $.now());
                })
            }
        </script>
        <script>
            function contain(chunk, bit) {
                var ch =  false;
                $.each(bit, function(i, a) {
                    if((chunk.toLowerCase()).includes(a)) {ch = true; return false;}
                });
                return ch;
            }
        </script>
        <script>
            //Info format: Type (0), size(1), quantity(2), price(3), sale(4), sale price(5), sale percent(6), value(7), alc value(8)
            function filterData(type, quant, size, kind, alc, price, keys) {
                var data = jQuery.parseJSON(window.localStorage.getItem('Data'));
                var delInd, delBrew = [];
                $.each(data, function(i, brew) {
                    delInd = [];
                    $.each(brew.info, function(j, conf) {
                        if(!type.includes(conf[0]) || conf[2] < quant[0] || conf[2] > quant[1] || parseInt(conf[1]) < size[0] || parseInt(conf[1]) > size[1] || parseFloat(brew.alcohol) < alc[0] || parseFloat(brew.alcohol) > alc[1] || parseFloat(conf[3]) < price[0] || parseFloat(conf[3]) > price[1] || !(contain(brew.brand, keys) || contain(brew.name, keys) || contain(brew.kind, keys) || contain(brew.style, keys))) {delInd.push(j); }  
                    });
                    if(delInd.length == 0) {return true;}
                    delInd.reverse();
                    $.each(delInd, function(j, ind) {brew.info.splice(ind, 1); });
                    if(brew.info.length == 0) {delBrew.push(i); }
                });
                delBrew.reverse();
                $.each(delBrew, function(i, ind) {data.splice(ind, 1); });
                data =  $.each(data, function(i, brew) {brew.rank = i;} );
                window.localStorage.setItem('modData', JSON.stringify(data));
                
                return data;
            }
        </script>
        <script>
            function populateTable(type, quant, size, kind, alc, price, keys) {
                var data = filterData(type, quant, size, kind, alc, price, keys);
                console.log('Good return.');
                var row, tableContents;
                tableContents = '<table class="table table-hover table-striped table-bordered" id="tableMark"><thread><tr><th>Beer</th><th>Type</th><th>Quantity</th><th>Size (mL)</th><th>Alcohol (%)</th><th>Price</th><th>Value (mL alc./$)</th><th>More</th></tr></thread>';
                
                $.each(data, function(i, brew) {
                    //Looks shitty but should be faster than individual += statements...
                    //Info format: Type (0), size(1), quantity(2), price(3), sale(4), sale price(5), sale percent(6), value(7), alc value(8)
                    tableContents += '<tr class="table-inner" id="tableMark"><th>'+brew.name+'</th><th>'+brew.info[0][0]+'</th><th class="tb-num">'+brew.info[0][2]+'</th><th class="tb-num">'+brew.info[0][1]+' mL</th><th class="tb-num">'+brew.alcohol.toFixed(1)+' %</th><th class="tb-num">'+brew.info[0][3].toFixed(2)+' $</th><th class="tb-num">'+brew.valAlc.toFixed(3)+' mL/$</th><th class="text-center"> <button class="btn btn-info" onclick="modalOnClick('+(brew.rank)+')">Info</button></th></tr>';
                });
                tableContents += '</table>';
                $('#tableMark').replaceWith(tableContents);
            }
        </script>
        <script>
            function modalOnClick(rank) {
                var brew, brewInfo, beerTable, picture;
                data = jQuery.parseJSON(window.localStorage.getItem('modData'));
                
                //Inserting modal title
                $('#beerTitle').replaceWith('<h4 class="modal-title text-center" id="beerTitle">'+data[rank].name+'</h4>');
                
                //Generating beer information
                beerInfo = '<div class="col" id="beerInfo"><b>Brewer: </b>'+data[rank].brand+'</br><b>Brew: </b>'+data[rank].name+'</br><b>Alcohol Content: </b>'+data[rank].alcohol.toFixed(1)+' %</br><b>Rank: </b>'+(data[rank].rank+1)+'</p></div>';
                
                //Generating beer table
                beerTable = '<div class="col" id="beerTable"><table class="table table-hover table-striped table-bordered"><thread><tr><th>Type</th><th>Quantity</th><th>Size</th><th>Price</th><th>Value</th><th>Alc. Value</th></tr></thread>';

                $.each(data[rank].info, function(ind, brew) {
                    //Info format: Type (0), size(1), quantity(2), price(3), sale(4), sale price(5), sale percent(6), value(7), alc value(8)
                    if(brew[4]==1) {
                        price = brew[5];
                        beerTable += '<tr class="success table-inner">';
                    } else {
                        price = brew[3];
                        beerTable += '<tr class="table-inner">';
                    }
                    beerTable += '<th>'+brew[0]+'</th><th class="mdl-tb">'+brew[2]+'</th><th class="mdl-tb">'+brew[1]+'</th><th class="mdl-tb">'+price.toFixed(2)+'</th><th class="mdl-tb">'+brew[7].toFixed(2)+'</th><th class="mdl-tb">'+brew[8].toFixed(2)+'</th></tr>';

                });
                
                picture = '<div class="col" id="beerPic"><img src="'+data[rank].pictureLink+'" class="img-fluid rounded center-block"></div>';

                $('#beerInfo').replaceWith(beerInfo);
                $('#beerPic').replaceWith(picture);
                $('#beerTable').replaceWith(beerTable);
                $('#modal').modal('show');
                /*
                $.getJSON('../data/jsonAllData.json', function(jsonData) {
                    var beerInfo, beerTable, price, toPageButt;
                    
                    
                    //Adding table rows
                        
                    beerTable += '</table><p><i>NOTE: Price given in CAD, Size in mL, value in mL per $, and alc. value in mL of alcohol per  $</i></p></div>';
                    
                    
                    beerLink = "'"+jsonData[rank].pageLink+"'";
                    $('#toPage').replaceWith('<input type="button" class="btn btn-secondary" id="toPage" value="Go to The Beer Store" onclick="window.open('+beerLink+')">');
                }) */
            }
        </script>
    </body>
</html>
